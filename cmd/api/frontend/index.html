<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DevrimSoft Feedback</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f4f5f7;--card:#fff;--border:#e2e4e9;--text:#1a1a1a;--muted:#6b7280;
  --accent:#2563eb;--accent-hover:#1d4ed8;--accent-light:#eff4ff;
  --success:#16a34a;--success-light:#f0fdf4;
  --error:#dc2626;--error-light:#fef2f2;
  --radius:10px;--font:'Inter',system-ui,-apple-system,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;min-height:100dvh}

/* Layout */
.page{max-width:600px;margin:0 auto;padding:20px 16px 40px}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.brand{display:flex;align-items:center;gap:10px}
.brand-icon{width:36px;height:36px;border-radius:9px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#fff;font-size:.875rem;flex-shrink:0}
.brand-text h1{font-size:.9375rem;font-weight:600;line-height:1.2}
.brand-text small{font-size:.6875rem;color:var(--muted);font-weight:400}

/* Language select */
.lang-select{position:relative}
.lang-btn{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;font:400 .75rem/1 var(--font);color:var(--text);transition:border-color .15s}
.lang-btn:hover{border-color:var(--accent)}
.lang-btn .flag{font-size:1.125rem;line-height:1}
.lang-btn i{font-size:.5rem;color:var(--muted);margin-left:2px}
.lang-menu{position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.1);display:none;flex-direction:column;overflow:hidden;z-index:100;min-width:150px}
.lang-menu.open{display:flex}
.lang-item{display:flex;align-items:center;gap:10px;padding:8px 14px;border:none;background:none;color:var(--text);font:400 .8125rem/1.3 var(--font);cursor:pointer;transition:background .1s;text-align:left;width:100%}
.lang-item:hover{background:var(--bg)}
.lang-item.active{background:var(--accent-light);color:var(--accent);font-weight:500}
.lang-item .flag{font-size:1rem;line-height:1}

/* Type toggle */
.type-toggle{display:flex;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:20px}
.type-toggle button{flex:1;padding:11px 16px;border:none;background:none;cursor:pointer;font:500 .8125rem/1.3 var(--font);color:var(--muted);transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px}
.type-toggle button:first-child{border-right:1px solid var(--border)}
.type-toggle button.active{background:var(--accent);color:#fff}
.type-toggle button i{font-size:.8125rem}

/* Card */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.card-title{font-size:.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;margin-bottom:14px;display:flex;align-items:center;gap:6px}
.card-title i{font-size:.6875rem}

/* Fields */
.field{margin-bottom:14px}
.field:last-child{margin-bottom:0}
label{display:block;font-size:.8125rem;font-weight:500;margin-bottom:4px;color:var(--text)}
label .req{color:var(--error);margin-left:2px}
.field-note{font-size:.6875rem;color:var(--muted);margin-top:3px}
.field-note.auto{color:var(--success);font-weight:500}

input,select,textarea{
  width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:8px;
  font:400 .8125rem/1.5 var(--font);background:var(--card);color:var(--text);
  outline:none;transition:border-color .15s
}
input::placeholder,textarea::placeholder{color:#c0c4cc}
input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.08)}
textarea{resize:vertical;min-height:90px}
select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%236b7280' d='M5 7L1 3h8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:30px;cursor:pointer}
select:disabled{opacity:.5;cursor:not-allowed}

.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

/* Collapsible */
.collapse-trigger{display:flex;align-items:center;gap:6px;font:500 .8125rem/1.3 var(--font);color:var(--accent);cursor:pointer;margin-bottom:12px;border:none;background:none;padding:0}
.collapse-trigger i{font-size:.625rem;transition:transform .2s}
.collapse-trigger.open i{transform:rotate(90deg)}
.collapse-body{display:none}
.collapse-body.open{display:block}

/* File upload */
.drop-zone{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all .15s;position:relative}
.drop-zone:hover,.drop-zone.drag-over{border-color:var(--accent);background:var(--accent-light)}
.drop-zone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.drop-zone i{font-size:1.25rem;color:var(--muted);display:block;margin-bottom:4px}
.drop-zone p{font-size:.75rem;color:var(--muted)}
.preview-grid{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.preview-item{position:relative;width:56px;height:56px;border-radius:6px;overflow:hidden;border:1px solid var(--border)}
.preview-item img{width:100%;height:100%;object-fit:cover}
.preview-item button{position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;border:none;background:rgba(0,0,0,.55);color:#fff;font-size:.5625rem;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* Turnstile */
.turnstile-wrap{display:flex;justify-content:center;margin-bottom:16px}

/* Submit */
.btn-submit{width:100%;padding:12px;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;font:600 .875rem/1.3 var(--font);cursor:pointer;transition:background .15s;display:flex;align-items:center;justify-content:center;gap:8px}
.btn-submit:hover{background:var(--accent-hover)}
.btn-submit:disabled{opacity:.45;cursor:not-allowed}

.msg{padding:12px 14px;border-radius:8px;font-size:.8125rem;margin-top:12px;display:none}
.msg.error{display:block;background:var(--error-light);color:var(--error);border:1px solid #fecaca}

.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .5s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Success overlay */
.success-overlay{display:none;position:fixed;inset:0;background:var(--bg);z-index:200;align-items:center;justify-content:center}
.success-overlay.visible{display:flex}
.success-content{text-align:center;padding:24px}
.success-check{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,#22c55e,#16a34a);display:inline-flex;align-items:center;justify-content:center;margin-bottom:20px;animation:popIn .4s cubic-bezier(.175,.885,.32,1.275)}
@keyframes popIn{0%{transform:scale(0);opacity:0}100%{transform:scale(1);opacity:1}}
.success-check i{font-size:1.75rem;color:#fff}
.success-content h2{font-size:1.25rem;font-weight:600;margin-bottom:6px}
.success-content p{color:var(--muted);font-size:.875rem;margin-bottom:24px;max-width:340px;margin-left:auto;margin-right:auto}
.btn-new{display:inline-flex;align-items:center;gap:8px;padding:10px 28px;border:1px solid var(--accent);border-radius:var(--radius);background:none;color:var(--accent);font:500 .875rem/1.3 var(--font);cursor:pointer;transition:all .15s}
.btn-new:hover{background:var(--accent);color:#fff}

/* Mobile adjustments */
@media(max-width:480px){
  .page{padding:12px 12px 32px}
  .row{grid-template-columns:1fr}
  .card{padding:16px}
  .type-toggle button{padding:10px 12px;font-size:.75rem}
}
</style>
</head>
<body>

<!-- Success Screen -->
<div class="success-overlay" id="successOverlay">
  <div class="success-content">
    <div class="success-check"><i class="fa-solid fa-check"></i></div>
    <h2 id="successTitle">Tesekkurler!</h2>
    <p id="successText">Geri bildiriminiz basariyla gonderildi. En kisa surede degerlendirilecektir.</p>
    <button class="btn-new" id="newReportBtn" onclick="resetForm()"><i class="fa-solid fa-plus"></i> <span id="newReportLabel">Yeni Bildirim</span></button>
  </div>
</div>

<div class="page">
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <div class="brand-icon"><i class="fa-solid fa-comment-dots"></i></div>
      <div class="brand-text">
        <h1>DevrimSoft</h1>
        <small id="pageSubtitle">Geri bildiriminizi paylasin</small>
      </div>
    </div>
    <div class="lang-select">
      <button class="lang-btn" id="langBtn" onclick="toggleLang()">
        <span class="flag" id="langFlag">&#127481;&#127479;</span>
        <span id="langLabel">TR</span>
        <i class="fa-solid fa-chevron-down"></i>
      </button>
      <div class="lang-menu" id="langMenu">
        <button class="lang-item active" data-lang="tr"><span class="flag">&#127481;&#127479;</span> Turkce</button>
        <button class="lang-item" data-lang="en"><span class="flag">&#127468;&#127463;</span> English</button>
        <button class="lang-item" data-lang="de"><span class="flag">&#127465;&#127466;</span> Deutsch</button>
        <button class="lang-item" data-lang="ru"><span class="flag">&#127479;&#127482;</span> Russky</button>
        <button class="lang-item" data-lang="uk"><span class="flag">&#127482;&#127462;</span> Ukrainska</button>
      </div>
    </div>
  </div>

  <!-- Report Type -->
  <div class="type-toggle" id="typeToggle">
    <button class="active" data-type="bug" onclick="setReportType('bug')"><i class="fa-solid fa-bug"></i> <span id="typeBugLabel">Hata Bildirimi</span></button>
    <button data-type="request" onclick="setReportType('request')"><i class="fa-solid fa-lightbulb"></i> <span id="typeRequestLabel">Oneriler</span></button>
  </div>

  <form id="feedbackForm" novalidate>
    <!-- Main Fields -->
    <div class="card">
      <div class="field">
        <label for="siteSelect" id="labelSite">Site <span class="req">*</span></label>
        <select id="siteSelect" required></select>
        <div class="field-note" id="siteNote"></div>
      </div>
      <div class="field">
        <label for="titleInput" id="labelTitle">Baslik <span class="req">*</span></label>
        <input type="text" id="titleInput" maxlength="200" required>
      </div>
      <div class="field">
        <label for="categorySelect" id="labelCategory">Kategori <span class="req">*</span></label>
        <select id="categorySelect" required>
          <option value="" id="optCatPlaceholder">Secin...</option>
          <option value="design" id="optDesign">Tasarim</option>
          <option value="functionality" id="optFunctionality">Islevsellik</option>
          <option value="performance" id="optPerformance">Performans</option>
          <option value="content" id="optContent">Icerik</option>
          <option value="mobile" id="optMobile">Mobil</option>
          <option value="security" id="optSecurity">Guvenlik</option>
          <option value="other" id="optOther">Diger</option>
        </select>
      </div>
      <div class="field">
        <label for="descInput" id="labelDesc">Aciklama <span class="req">*</span></label>
        <textarea id="descInput" maxlength="5000" required></textarea>
      </div>
      <div class="field">
        <label for="pageUrlInput" id="labelPageUrl">Sayfa URL'i</label>
        <input type="url" id="pageUrlInput" placeholder="https://...">
      </div>
    </div>

    <!-- Contact (Collapsible) -->
    <div class="card">
      <button type="button" class="collapse-trigger" id="contactTrigger" onclick="toggleCollapse()">
        <i class="fa-solid fa-chevron-right"></i>
        <span id="labelContact">Iletisim Bilgileri (Opsiyonel)</span>
      </button>
      <div class="collapse-body" id="contactBody">
        <div class="row">
          <div class="field">
            <label for="firstNameInput" id="labelFirstName">Ad</label>
            <input type="text" id="firstNameInput" maxlength="100">
          </div>
          <div class="field">
            <label for="lastNameInput" id="labelLastName">Soyad</label>
            <input type="text" id="lastNameInput" maxlength="100">
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div class="field">
            <label for="contactTypeSelect" id="labelContactType">Iletisim Turu</label>
            <select id="contactTypeSelect">
              <option value="">-</option>
              <option value="email">E-posta</option>
              <option value="phone" id="optPhone">Telefon</option>
              <option value="telegram">Telegram</option>
              <option value="instagram">Instagram</option>
            </select>
          </div>
          <div class="field">
            <label for="contactValueInput" id="labelContactValue">Iletisim Degeri</label>
            <input type="text" id="contactValueInput" maxlength="200">
          </div>
        </div>
      </div>
    </div>

    <!-- Images -->
    <div class="card">
      <div class="card-title"><i class="fa-solid fa-image"></i> <span id="labelImages">Gorseller (Maks. 5)</span></div>
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" multiple accept="image/png,image/jpeg,image/webp,image/gif">
        <i class="fa-solid fa-cloud-arrow-up"></i>
        <p id="dropText">Dosyalari surukleyin veya tiklayin</p>
      </div>
      <div class="preview-grid" id="previewGrid"></div>
    </div>

    <!-- Turnstile + Submit -->
    <div class="turnstile-wrap" id="turnstileWrap"></div>
    <button type="submit" class="btn-submit" id="submitBtn" disabled>
      <i class="fa-solid fa-paper-plane"></i>
      <span id="submitLabel">Gonder</span>
    </button>
    <div class="msg" id="resultMsg"></div>
  </form>
</div>

<script>
const API_KEY='__PORTAL_API_KEY__';
const TURNSTILE_SITE_KEY='__TURNSTILE_SITE_KEY__';
const INJECTED_SITES=__SITES_JSON__;

const FLAGS={tr:'\u{1F1F9}\u{1F1F7}',en:'\u{1F1EC}\u{1F1E7}',de:'\u{1F1E9}\u{1F1EA}',ru:'\u{1F1F7}\u{1F1FA}',uk:'\u{1F1FA}\u{1F1E6}'};

const T={
  tr:{pageSubtitle:'Geri bildiriminizi paylasin',labelSite:'Site',labelTitle:'Baslik',labelCategory:'Kategori',labelDesc:'Aciklama',labelPageUrl:"Sayfa URL'i",labelContact:'Iletisim Bilgileri (Opsiyonel)',labelFirstName:'Ad',labelLastName:'Soyad',labelContactType:'Iletisim Turu',labelContactValue:'Iletisim Degeri',labelImages:'Gorseller (Maks. 5)',dropText:'Dosyalari surukleyin veya tiklayin',submitBtn:'Gonder',sending:'Gonderiliyor...',errorGeneric:'Bir hata olustu. Lutfen tekrar deneyin.',autoDetected:'Otomatik algilandi',selectPlaceholder:'Secin...',catDesign:'Tasarim',catFunctionality:'Islevsellik',catPerformance:'Performans',catContent:'Icerik',catMobile:'Mobil',catSecurity:'Guvenlik',catOther:'Diger',optPhone:'Telefon',titlePlaceholder:'Kisa bir baslik yazin',descPlaceholder:'Detayli olarak aciklayin',maxImages:'En fazla 5 gorsel yuklenebilir',siteSelectPlaceholder:'Site secin...',typeBug:'Hata Bildirimi',typeRequest:'Oneriler',successTitle:'Tesekkurler!',successText:'Geri bildiriminiz basariyla gonderildi. En kisa surede degerlendirilecektir.',newReport:'Yeni Bildirim'},
  en:{pageSubtitle:'Share your feedback',labelSite:'Site',labelTitle:'Title',labelCategory:'Category',labelDesc:'Description',labelPageUrl:'Page URL',labelContact:'Contact Info (Optional)',labelFirstName:'First Name',labelLastName:'Last Name',labelContactType:'Contact Type',labelContactValue:'Contact Value',labelImages:'Screenshots (Max 5)',dropText:'Drag files here or click to browse',submitBtn:'Submit',sending:'Sending...',errorGeneric:'An error occurred. Please try again.',autoDetected:'Auto-detected',selectPlaceholder:'Select...',catDesign:'Design',catFunctionality:'Functionality',catPerformance:'Performance',catContent:'Content',catMobile:'Mobile',catSecurity:'Security',catOther:'Other',optPhone:'Phone',titlePlaceholder:'Write a short title',descPlaceholder:'Describe in detail',maxImages:'Maximum 5 images allowed',siteSelectPlaceholder:'Select a site...',typeBug:'Bug Report',typeRequest:'Suggestions',successTitle:'Thank you!',successText:'Your feedback has been submitted successfully. It will be reviewed shortly.',newReport:'New Report'},
  de:{pageSubtitle:'Teilen Sie Ihr Feedback',labelSite:'Webseite',labelTitle:'Titel',labelCategory:'Kategorie',labelDesc:'Beschreibung',labelPageUrl:'Seiten-URL',labelContact:'Kontaktdaten (Optional)',labelFirstName:'Vorname',labelLastName:'Nachname',labelContactType:'Kontaktart',labelContactValue:'Kontaktwert',labelImages:'Bilder (Max. 5)',dropText:'Dateien hierher ziehen oder klicken',submitBtn:'Absenden',sending:'Wird gesendet...',errorGeneric:'Fehler aufgetreten. Bitte erneut versuchen.',autoDetected:'Automatisch erkannt',selectPlaceholder:'Auswahlen...',catDesign:'Design',catFunctionality:'Funktionalitat',catPerformance:'Leistung',catContent:'Inhalt',catMobile:'Mobil',catSecurity:'Sicherheit',catOther:'Sonstiges',optPhone:'Telefon',titlePlaceholder:'Kurzen Titel eingeben',descPlaceholder:'Beschreiben Sie es im Detail',maxImages:'Maximal 5 Bilder',siteSelectPlaceholder:'Webseite auswahlen...',typeBug:'Fehlerbericht',typeRequest:'Vorschlage',successTitle:'Vielen Dank!',successText:'Ihr Feedback wurde erfolgreich gesendet.',newReport:'Neuer Bericht'},
  ru:{pageSubtitle:'Podelites otzyvom',labelSite:'Sayt',labelTitle:'Zagolovok',labelCategory:'Kategoriya',labelDesc:'Opisaniye',labelPageUrl:'URL stranitsy',labelContact:'Kontakty (Neobyzatelno)',labelFirstName:'Imya',labelLastName:'Familiya',labelContactType:'Tip kontakta',labelContactValue:'Znacheniye',labelImages:'Izobrazheniya (Maks. 5)',dropText:'Peretashchite fayly ili nazmite',submitBtn:'Otpravit',sending:'Otpravka...',errorGeneric:'Oshibka. Poprobuyete snova.',autoDetected:'Opredeleno avtomaticheski',selectPlaceholder:'Vybrat...',catDesign:'Dizayn',catFunctionality:'Funktsionalnost',catPerformance:'Proizvoditelnost',catContent:'Kontent',catMobile:'Mobilniy',catSecurity:'Bezopasnost',catOther:'Drugoye',optPhone:'Telefon',titlePlaceholder:'Korotkiy zagolovok',descPlaceholder:'Podrobno opishite',maxImages:'Maksimum 5',siteSelectPlaceholder:'Vybrat sayt...',typeBug:'Oshibka',typeRequest:'Predlozheniya',successTitle:'Spasibo!',successText:'Vash otzyv uspeshno otpravlen.',newReport:'Novyy otchet'},
  uk:{pageSubtitle:'Podilitsya vidgukom',labelSite:'Sayt',labelTitle:'Zagolovok',labelCategory:'Kategoriya',labelDesc:'Opys',labelPageUrl:'URL storinky',labelContact:"Kontakty (Neobov'yazkovo)",labelFirstName:"Im'ya",labelLastName:'Prizvyshche',labelContactType:'Typ kontaktu',labelContactValue:'Znachennya',labelImages:'Zobrazhennya (Maks. 5)',dropText:'Peretagnit fayly abo natysnit',submitBtn:'Vidpravyty',sending:'Vidpravka...',errorGeneric:'Pomylka. Sprobujte shche raz.',autoDetected:'Vyznacheno avtomatychno',selectPlaceholder:'Obraty...',catDesign:'Dyzayn',catFunctionality:'Funktsionalnist',catPerformance:'Produktyvnist',catContent:'Kontent',catMobile:'Mobilnyy',catSecurity:'Bezpeka',catOther:'Inshe',optPhone:'Telefon',titlePlaceholder:'Korotkyy zagolovok',descPlaceholder:'Detalno opishit',maxImages:'Maksymum 5',siteSelectPlaceholder:'Obraty sayt...',typeBug:'Pomylka',typeRequest:'Propozytsii',successTitle:'Dyakuyemo!',successText:'Vash vidguk uspishno vidpravleno.',newReport:'Novyy zvit'}
};

let currentLang='tr',sites=[],selectedFiles=[],autoDetectedSite=false,currentReportType='bug',turnstileWidgetId=null;

function detectLang(){
  const n=(navigator.language||'tr').toLowerCase();
  if(n.startsWith('en'))return'en';if(n.startsWith('de'))return'de';if(n.startsWith('ru'))return'ru';if(n.startsWith('uk'))return'uk';return'tr';
}

/* Language */
function toggleLang(){
  document.getElementById('langMenu').classList.toggle('open');
}
function setLang(lang){
  currentLang=lang;const t=T[lang];
  document.documentElement.lang=lang;
  document.getElementById('langFlag').textContent=FLAGS[lang];
  document.getElementById('langLabel').textContent=lang.toUpperCase();
  document.querySelectorAll('.lang-item').forEach(el=>el.classList.toggle('active',el.dataset.lang===lang));
  document.getElementById('langMenu').classList.remove('open');

  document.getElementById('pageSubtitle').textContent=t.pageSubtitle;
  el('labelSite').innerHTML=t.labelSite+' <span class="req">*</span>';
  el('labelTitle').innerHTML=t.labelTitle+' <span class="req">*</span>';
  el('labelCategory').innerHTML=t.labelCategory+' <span class="req">*</span>';
  el('labelDesc').innerHTML=t.labelDesc+' <span class="req">*</span>';
  el('labelPageUrl').textContent=t.labelPageUrl;
  el('labelContact').textContent=t.labelContact;
  el('labelFirstName').textContent=t.labelFirstName;
  el('labelLastName').textContent=t.labelLastName;
  el('labelContactType').textContent=t.labelContactType;
  el('labelContactValue').textContent=t.labelContactValue;
  el('labelImages').textContent=t.labelImages;
  el('dropText').textContent=t.dropText;
  el('titleInput').placeholder=t.titlePlaceholder;
  el('descInput').placeholder=t.descPlaceholder;
  el('typeBugLabel').textContent=t.typeBug;
  el('typeRequestLabel').textContent=t.typeRequest;
  el('successTitle').textContent=t.successTitle;
  el('successText').textContent=t.successText;
  el('newReportLabel').textContent=t.newReport;
  el('optCatPlaceholder').textContent=t.selectPlaceholder;
  el('optDesign').textContent=t.catDesign;
  el('optFunctionality').textContent=t.catFunctionality;
  el('optPerformance').textContent=t.catPerformance;
  el('optContent').textContent=t.catContent;
  el('optMobile').textContent=t.catMobile;
  el('optSecurity').textContent=t.catSecurity;
  el('optOther').textContent=t.catOther;
  el('optPhone').textContent=t.optPhone;
  if(autoDetectedSite) el('siteNote').textContent=t.autoDetected;
  if(!el('submitBtn').innerHTML.includes('spinner')) el('submitLabel').textContent=t.submitBtn;
  updateSiteSelect();
}
function el(id){return document.getElementById(id)}

/* Report type */
function setReportType(type){
  if(currentReportType===type)return;
  currentReportType=type;
  document.querySelectorAll('#typeToggle button').forEach(b=>b.classList.toggle('active',b.dataset.type===type));
  // Clear form
  el('feedbackForm').reset();
  el('titleInput').value='';el('descInput').value='';el('categorySelect').value='';
  el('pageUrlInput').value='';el('firstNameInput').value='';el('lastNameInput').value='';
  el('contactTypeSelect').value='';el('contactValueInput').value='';
  selectedFiles=[];renderPreviews();
  if(autoDetectedSite){el('siteSelect').disabled=true;matchReferrer()}
  if(turnstileWidgetId!==null){turnstile.reset(turnstileWidgetId);el('submitBtn').disabled=true}
  el('resultMsg').className='msg';el('resultMsg').style.display='none';
}

/* Collapsible contact */
function toggleCollapse(){
  el('contactTrigger').classList.toggle('open');
  el('contactBody').classList.toggle('open');
}

/* Sites */
function updateSiteSelect(){
  const sel=el('siteSelect');const t=T[currentLang];const cv=sel.value;sel.innerHTML='';
  const ph=document.createElement('option');ph.value='';ph.textContent=t.siteSelectPlaceholder;sel.appendChild(ph);
  sites.forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o)});
  if(cv&&sites.includes(cv))sel.value=cv;
}
function loadSites(){
  sites=INJECTED_SITES||[];
  updateSiteSelect();
  matchReferrer();
}
function matchReferrer(){
  const ref=document.referrer;if(!ref)return;
  try{
    const h=new URL(ref).hostname.toLowerCase();
    const m=sites.find(s=>h===s||h.endsWith('.'+s));
    if(m){
      el('siteSelect').value=m;el('siteSelect').disabled=true;autoDetectedSite=true;
      el('siteNote').textContent=T[currentLang].autoDetected;el('siteNote').classList.add('auto');
    }
  }catch(e){}
}

/* Files */
function renderPreviews(){
  const g=el('previewGrid');g.innerHTML='';
  selectedFiles.forEach((f,i)=>{
    const item=document.createElement('div');item.className='preview-item';
    const img=document.createElement('img');img.src=URL.createObjectURL(f);img.onload=()=>URL.revokeObjectURL(img.src);
    const btn=document.createElement('button');btn.type='button';btn.innerHTML='<i class="fa-solid fa-xmark"></i>';
    btn.onclick=()=>{selectedFiles.splice(i,1);renderPreviews()};
    item.appendChild(img);item.appendChild(btn);g.appendChild(item);
  });
}
function addFiles(files){
  const t=T[currentLang];const ok=['image/png','image/jpeg','image/webp','image/gif'];
  for(const f of files){if(selectedFiles.length>=5){alert(t.maxImages);break}if(ok.includes(f.type)&&f.size<=5*1024*1024)selectedFiles.push(f)}
  renderPreviews();
}

/* Turnstile */
function initTurnstile(){
  if(!TURNSTILE_SITE_KEY||TURNSTILE_SITE_KEY==='__TURNSTILE_SITE_KEY__'){
    el('submitBtn').disabled=true;
    el('turnstileWrap').innerHTML='<p style="color:var(--error);font-size:.75rem">Turnstile not configured</p>';
    return;
  }
  turnstileWidgetId=turnstile.render(el('turnstileWrap'),{
    sitekey:TURNSTILE_SITE_KEY,theme:'light',
    callback:()=>{el('submitBtn').disabled=false},
    'expired-callback':()=>{el('submitBtn').disabled=true},
    'error-callback':()=>{el('submitBtn').disabled=true}
  });
}

/* Success / Reset */
function showSuccess(){el('successOverlay').classList.add('visible')}
function resetForm(){
  el('successOverlay').classList.remove('visible');
  el('feedbackForm').reset();selectedFiles=[];renderPreviews();
  currentReportType='bug';
  document.querySelectorAll('#typeToggle button').forEach(b=>b.classList.toggle('active',b.dataset.type==='bug'));
  if(autoDetectedSite){el('siteSelect').disabled=true;matchReferrer()}
  if(turnstileWidgetId!==null){turnstile.reset(turnstileWidgetId);el('submitBtn').disabled=true}
  el('resultMsg').className='msg';el('resultMsg').style.display='none';
}

/* Submit */
async function submitForm(e){
  e.preventDefault();const t=T[currentLang];const btn=el('submitBtn');const msg=el('resultMsg');
  msg.className='msg';msg.style.display='none';btn.disabled=true;
  btn.innerHTML='<span class="spinner"></span> '+t.sending;
  const fd=new FormData();
  fd.append('site_id',el('siteSelect').value);
  fd.append('report_type',currentReportType);
  fd.append('title',el('titleInput').value.trim());
  fd.append('category',el('categorySelect').value);
  fd.append('description',el('descInput').value.trim());
  const pu=el('pageUrlInput').value.trim();if(pu)fd.append('page_url',pu);
  const fn=el('firstNameInput').value.trim();if(fn)fd.append('first_name',fn);
  const ln=el('lastNameInput').value.trim();if(ln)fd.append('last_name',ln);
  const ct=el('contactTypeSelect').value;if(ct)fd.append('contact_type',ct);
  const cv=el('contactValueInput').value.trim();if(cv)fd.append('contact_value',cv);
  selectedFiles.forEach(f=>fd.append('images',f));
  const ti=document.querySelector('[name="cf-turnstile-response"]');if(ti)fd.append('cf-turnstile-response',ti.value);
  try{
    const r=await fetch('/v1/reports',{method:'POST',headers:{'X-API-Key':API_KEY},body:fd});const d=await r.json();
    if(r.ok){showSuccess()}else{
      msg.className='msg error';msg.textContent=d.error||t.errorGeneric;msg.style.display='block';
      btn.innerHTML='<i class="fa-solid fa-paper-plane"></i> <span id="submitLabel">'+t.submitBtn+'</span>';
      if(turnstileWidgetId!==null){turnstile.reset(turnstileWidgetId);btn.disabled=true}
    }
  }catch(err){
    msg.className='msg error';msg.textContent=t.errorGeneric;msg.style.display='block';
    btn.innerHTML='<i class="fa-solid fa-paper-plane"></i> <span id="submitLabel">'+t.submitBtn+'</span>';
    if(turnstileWidgetId!==null){turnstile.reset(turnstileWidgetId);btn.disabled=true}
  }
}

/* Init */
document.addEventListener('DOMContentLoaded',()=>{
  setLang(detectLang());loadSites();
  el('feedbackForm').addEventListener('submit',submitForm);
  el('fileInput').addEventListener('change',e=>addFiles(e.target.files));
  const dz=el('dropZone');
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag-over')});
  dz.addEventListener('dragleave',()=>dz.classList.remove('drag-over'));
  dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('drag-over');addFiles(e.dataTransfer.files)});
  document.querySelectorAll('.lang-item').forEach(o=>o.addEventListener('click',()=>setLang(o.dataset.lang)));
  document.addEventListener('click',e=>{if(!e.target.closest('.lang-select'))el('langMenu').classList.remove('open')});
  if(typeof turnstile!=='undefined'){initTurnstile()}else{
    const ch=setInterval(()=>{if(typeof turnstile!=='undefined'){clearInterval(ch);initTurnstile()}},100);
  }
});
</script>
</body>
</html>
